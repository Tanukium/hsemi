# 180716：Pugの「出力しないコード」でテーブルを作る機能をサーバ側に移行

前回はPOSTメソッドで指定の大きさの表を作ることができたが、その成果を先生に示したら二つの問題点を指摘していただいた。

* 行と列などの簡単なパラメータ（引数）を渡すときPOSTより普通GETを使った方がいい
* 「テーブルを作る」部分のスクリプトをクライエント側で実行させるよりサーバ側に移行した方がいい
  
一つ目はなんとなく分かったが、二つ目はどう考えたりググったりしても実際の実現する方法が思い出せなかった。  
その時、先生からさらに「Pugの組み込みスクリプト機能を使ったら」とのアドバイスをいただいた。  
ありがどう先生（涙）。

そのため、今回の日誌では二つの問題をどう解決したかを説明する。

***

## 行と列の引数伝達をPOSTからGETに移行

POSTメソッドの使い方を書いた回では既に説明したが、訳が分からないが`app.post()`関数は`routes/`フォルダのサブルータに書き込めなく、`app.js`にしか書き込めないらしい。  
そのため、まずは`app.js`にある、`app.post('sand'`から始まるブロックを削除してからセーブする。

次は`routes/sand.js`（`サイト/sand`をコントロールするサブルータファイル）を開き、唯一の`router.get`から始まるブロックの中にある、`res.render`関数のパラメータを編集する。  
`rowNum: 5`と`colNum: 6`を削除して、代わりに下の一行を書き込む。

```
row: `${req.query.row}`, col: `${req.query.col}`
```

GETメソッドを使うリクエストも、`{key: value}`の形のObjectオブジェクトである。  
しかし、リクエストが含むキーの値（バリュー）を呼び出すメソッドは`req.body`ではなく、`req.query`になった。  
これも何度も試行錯誤した私が先生から（何回目かもう覚えられない）いただいたアドバイスであった。

私の力ではデフォルトで渡す値がセットできないので、サブルータファイルの、リクエストを処理してリスポンスをクライエント側に返す、`router.get(){res.render()}`ブロックを簡単に書き換えた。  
そのブロックが`row`と`col`という、Expressがブラウザに渡す引数を二つ作った上で、GETで発送された`{row: hoge, col: fuga}`のようなリクエストの値を引数にそれぞれ渡す。  
その後、二つの引数をリスポンスとして返す。これは今回書き換えたそのブロックのロジックである。

最後は`views/sand/index.pug`にGETを応用させた話だが、それは次の「テーブル生成をサーバ側に移行」というトピックにも関連しているので、そこで説明させていただく。

***

## テーブル生成をサーバ側に移行

今度の移行は、完全に``views/sand/index.pug`を編集するだけでいい仕事だった。

徹底した移行なので、まずは`block script`から始まるブロックの、`script(type="text/javascript").`以下の（その行自体は含まれない）内容を全部削除する。  
ただし、次回の保存機能を考えて、テスト用の`test`関数を一つ作る必要がある。

```
let test = () => {
    alert("Test");
}
```

以上の内容を`script(type="text/javascript").`の下に補充すればいい。

次は、もう一つ新たなPug文法を紹介しよう。それは、「出力しないコード」（Unbuffered Code）機能である。

Pugのドキュメントでは、`-`というマークを紹介した。そのマークで始まる行は、文字としてページに出力することなく、JavaScriptとして実行する。  
もっと面白いのは、その行が直接にPug文法のHTMLエレメントも処理できる。  
例えば、以下のブロックは望まれる『「item」というエレメントを三行のリストで出力する』との効果が実現できる：

```
- for (var x = 0; x < 3; x++)
  li item
```

しかし、Pugのドキュメントはそのマークの全ての機能を説明していないらしい。例えば、`-`マークから始まる行では、Expressから渡した引数を直接名前で呼び出す特性がある。  
すなわち、わざわざ`#{hogehoge}`のような記法を使う必要はなくなる。これがグーグルで入手した豆知識だったが、案外役に立ったものである。

***

[前のページに戻る][]


[前のページに戻る]: /blog "ブログ"