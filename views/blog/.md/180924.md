# 180924：テーブルを保存する機能を添付する

## （お詫びの）前書き

実は[180709][]と[180716][]の二回分の日誌は、前期最後の二週間でなく、この前の夏休みで完成したばかりのものであった。  
そして恥ずかしながら、二年ぶりの実家帰省のせいで、この夏休みではこの二回分の日誌だけを補足・完成してしまった。つまり、新たな進展は全くなく、申し訳なかったものである。  
この後期の時間をじっくりと利用して、できる限り卒論を完成するよう、改めて頑張っていく。

***

## テーブルに書き込んだ内容を簡単に保存

現段階で私個人の考えは

* デーブルに書き込んだ内容を（何らかの形で）サーバ側に保存する
* サーバ側が保存されたものをCSVに転換
* JSのメソッドで転換されたものをクライアント側（ブラウザ）に返す
  
というふうなものである。まずは、第一段階から実現する。

前回で私たちがわざと作ったテーブルのセルごとに「クラス」という属性に振り分けた。  
今度サーバ側に保存したものは、「クラスの値->書き込んだ内容」の形の、対応関係のあるハッシュテーブルみたいなものが望ましい。  
そのため、今度もObjectオブジェクトを使いたい。

簡単な復習だが、`{key: value}`のようなObjectオブジェクトの値を呼び出し方は`Object.key`である。  
では、Objectオブジェクトの「キー・値」のペアを作る方法も説明する。  
`Object[key] = value`で、`key`が存在するかしないか関係なく、その`key`に`value`という値を新たに渡す。
そこで、テーブルの「クラスの値」と書き込んだ内容を一緒に渡す最初の（仮）コードも考え出せる：

```
let テーブル = new Object;
for( let i = 0; i < 行数; i++ ){
    for( let j = 0; j < 列数; j++){
        テーブル[i+':'+j] = セルに書き込んだ内容;
    };
};
```

とにかく論理を出しちゃった。次の問題は、テーブルと、その中のセルに書き込んだ内容をどうやって手に入れることだ。  
グーグルで出た[このサイト][site1]と[このサイト][site2]を参照して、セルに書き込んだ内容を読み込むやり方を実践した。

* `let table = document.getElementById('demo');`のような式は`<table id=demo>...</table>`のようなかたちで、id属性は`'demo'`の`<table>`ノードとその下の全部子ノードを返す。
* `let cells = temp.getElementsByClassName('i:j')`は`temp`の中の、クラスの値が`i:j`のノードの配列を全部返す。今の論理は「クラスの値がセルの位置を示して唯一」なので、長さは1の、`<td class='i:j'>...</td>`という要素を含める配列を返す。
* `cells[0].childNodes`は、さきの`<td>`ノードの中の子ノードたちの配列を返す。ここでは`<input>`子ノード（最終ノード）だけを含める配列を返す。
* `cells[0].childNodes[0].value`は、セルに書き込んだ内容（`<input>`ノードのvalue）を返す。

やっとここまでたどり着いた。最初の（仮）コードを進化させよう。

```
let demoTable = document.getElementById('demo');
let cell = new Object;
let value = new Object;
for( let i = 0; i < #{row}; i++ ){
    for( let j = 0; j < #{col}; j++){
        cell = demoTable.getElementsByClassName(i+':'+j)[0];
        value[i+':'+j] = cell.childNodes[0].value;
    };
};
return(value);
```

`#{row}`の記法は、Expressがブラウザに渡したrowのパラメータを導入するものである。前回も簡単に説明した。

ただし、将来に備えて、CSVにおける改行も考えなければならない。幸いのは、それはそんなに難しくはないものだ。  
一回目のforループの下に`value[i+':'+'-1'] = '\\r';`との一行を挿入すると完成である。  
JSでは`\`が特別なマークなので、`\\`で`\`を表す。

実際にテストしてみると、`{0:0: ..., 0:1: ..., ... i:j: ...}`のようなObjectオブジェクトが出力された。  
それをどうやってCSVに転換するかについては、次回の課題である。

***

[前のページに戻る][]

[前のページに戻る]: /blog "ブログ"
[180709]: /blog/180709 "180709"
[180716]: /blog/180716 "180716"
[site1]: https://www.cnblogs.com/shengulong/p/8919747.html "js获取table的值，js获取td里input的值"
[site2]: https://www.cnblogs.com/hl-520/p/4245475.html "原生js获取元素的class属性（获取class的所有元素）以及改变或添加className"