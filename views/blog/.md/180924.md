## （お詫びの）前書き

実は[180709][]と[180716][]の二回分の日誌は、前期最後の二週間でなく、この前の夏休みで完成したばかりのものであった。  
そして恥ずかしながら、二年ぶりの実家帰省のせいで、この夏休みではこの二回分の日誌だけを補足・完成してしまった。つまり、新たな進展は全くなく、申し訳なかったものである。  
この後期の時間をじっくりと利用して、できる限り卒論を完成するよう、改めて頑張っていく。

***

## テーブルに書き込んだ内容を簡単に保存

現段階で私個人の考えは

* デーブルに書き込んだ内容を（何らかの形で）サーバ側に保存する
* サーバ側が保存されたものをCSVに転換
* JSのメソッドで転換されたものをクライアント側（ブラウザ）に返す
  

というふうなものである。まずは、第一段階から実現する。

前回で私たちがわざと作ったテーブルのセルごとに「クラス」という属性に振り分けた。  
今度サーバ側に保存したものは、「クラスの値->書き込んだ内容」の形の、対応関係のあるハッシュテーブルみたいなものが望ましい。  
そのため、今度もObjectオブジェクトを使いたい。

簡単な復習だが、`{key: value}`のようなObjectオブジェクトの値を呼び出し方は`Object.key`である。  
では、Objectオブジェクトの「キー・値」のペアを作る方法も説明する。  
`Object[key] = value`で、`key`が存在するかしないか関係なく、その`key`に`value`という値を新たに渡す。
そこで、テーブルの「クラスの値」と書き込んだ内容を一緒に渡す最初の（仮）コードも考え出せる：

```
let テーブル = new Object;
for( let i = 0; i < 行数; i++ ){
    for( let j = 0; j < 列数; j++){
        テーブル[i+':'+j] = セルに書き込んだ内容;
    };
};
```

とにかく論理を出しちゃった。次の問題は、テーブルと、その中のセルに書き込んだ内容をどうやって手に入れることだ。  
グーグルで出た[このサイト][site1]と[このサイト][site2]を参照して、セルに書き込んだ内容を読み込むやり方を実践した。

* `let table = document.getElementById('demo');`のような式は`<table id=demo>...</table>`のようなかたちで、id属性は`'demo'`の`<table>`ノードとその下の全部子ノードを返す。
* `let cells = temp.getElementsByClassName('i:j')`は`temp`の中の、クラスの値が`i:j`のノードの配列を全部返す。今の論理は「クラスの値がセルの位置を示して唯一」なので、長さは1の、`<td class='i:j'>...</td>`という要素を含める配列を返す。
* `cells[0].childNodes`は、さきの`<td>`ノードの中の子ノードたちの配列を返す。ここでは`<input>`子ノード（最終ノード）だけを含める配列を返す。
* `cells[0].childNodes[0].value`は、セルに書き込んだ内容（`<input>`ノードのvalue）を返す。

やっとここまでたどり着いた。最初の（仮）コードを進化させよう。

```
let demoTable = document.getElementById('demo');
let cell = new Object;
let value = new Object;
for( let i = 0; i < #{row}; i++ ){
    for( let j = 0; j < #{col}; j++){
        cell = demoTable.getElementsByClassName(i+':'+j)[0];
        value[i+':'+j] = cell.childNodes[0].value;
    };
};
return(value);
```

`#{row}`の記法は、Expressがブラウザに渡したrowのパラメータを導入するものである。前回も簡単に説明した。

ただし、将来に備えて、CSVにおける改行も考えなければならない。幸いのは、それはそんなに難しくはないものだ。  
一回目のforループの下に`value[i+':'+'-1'] = '\\r';`との一行を挿入すると完成である。  
JSでは`\`が特別なマークなので、`\\`で`\`を表す。

## コードを実験用のページ(`sand/index.pug`)に挿入する

`sand/index.pug`における`block script`は、もともとJSを実行するために用意されたスペースであった。  
先程デザインしたばかりのコードをパッキングして、関数としてそちらに組み込むべきである。

### JSにおける関数の記法

RubyとPythonのような（ちゃんとした）スクリプト言語とは異なり、JSでの関数宣言は`def`ではなく`function`というキーワードを使うことになっている。  
基本的な構文は

```
function myFunction (param1, param2, ...) {
    body
}
```

のような仕組みになっている。`myFunction`は関数名で、`param1`と`param2`などの括弧にあるものはパラメータである。関数のボディは、大括弧にある`body`の部分である。JSはPythonのように自動でパラメータのクラスを判断するので、Rubyのような`param: class`記法を書く必要はない。

上記の記法はES6以前の伝統的記法である。ES6から、新たな記法「アロー関数」が導入された。アロー関数式は、主に

1. 構文自体は簡潔である
2. `this`、`arguments`、`super`、`new.target`を束縛しない
3. メソッドでない（動作しない）関数や、無名関数に最適である

以上の特徴を持っている。  
本プロジェクトでは、上記の特徴を順守し、動作するかどうかを基づき、アロー関数式で書くべきかを判断することになった。なお、§3.1 『問題提起』において説明した通りに、「開発言語の高級な特性をなるべく使用しない」という理由で、２番目の特徴における上級構文が本プロジェクト内で扱われていない。

それから、アロー関数式の構文を例で説明する。  
（無名関数の場合）

```
(param1, param2, ...) => {body}
```

パラメータはないなら簡単に`()=>{body}`のように書いても問題ない。  
無名関数ではない場合、`var`か`let`キーワードで変数にバインドすることになる。  
記法は下記のようである。

```
let variable = (param1, param2, ...) => {body}
```

### 関数になったコードをページに組み込む

先程のコードを`let saveTable = () => {}`の大括弧内に貼り付けたら、関数化が完了した。  
次は、`block script`内でJS用のブロックを作成する。

HTMLにおいて、JS言語を組み込む場合に使用されるタグは`<script type="text/javascript"></script>`である。それをpugの書き方に切り替えたら、`script(type="text/javascript").`になる。  
説明すべきのは、上記の構文の最後の`.`を忘れないこと。タグの後ろの`.`は、「次のインデントからインデントが終わるまで全部このタグの内容である」と宣言する意味を有するので、ブロックを作るときには非常に便利である。

`script(type="text/javascript").`を`block script`の下に（インデントで）貼り付けたら、作成した`let saveTable...`という関数をさらにインデントで`script(type="text/javascript").`の下に貼り付ける。  
最後はこのようなコードを得た。

```
block script
  script(type="text/javascript").
    let saveTable = () => {
        let demoTable = document.getElementById('demo');
        let cell = new Object;
        let value = new Object;
        for( let i = 0; i < #{row}; i++ ){
            for( let j = 0; j < #{col}; j++){
                cell = demoTable.getElementsByClassName(i+':'+j)[0];
                value[i+':'+j] = cell.childNodes[0].value;
            };
        };
        return(value);
    }
```

§3.2.6 『「表を作る」部分をサーバ側に移行』の最後では、`button(onclick="test()") 保存`の一文で仮の保存機能用のボタン一つを作った。先程作成されたコードの効果を検証するために、`test()`を新たな関数に入れ替えるべきである。ただし、`saveTable()`はコンソールに出力する動作を有せず、ただ`value`を値として返すことになるため、`test()`の代わりに書き込むのは`saveTable()`でなく`console.log(saveTable());`である。

実際に実験用のページのボタンを押してテストしてみると、`{0:0: ..., 0:1: ..., ... i:j: ...}`のようなObjectオブジェクトがコンソールに出力された。  
それをどうやってCSVに転換するかについては、次回の課題である。

***


[180709]: /sts/blog/180709 "180709"
[180716]: /sts/blog/180716 "180716"
[site1]: https://www.cnblogs.com/shengulong/p/8919747.html "js获取table的值，js获取td里input的值"
[site2]: https://www.cnblogs.com/hl-520/p/4245475.html "原生js获取元素的class属性（获取class的所有元素）以及改变或添加className"
